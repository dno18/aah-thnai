// Language Management
const translations = {
    ar: {
        // Navigation
        "nav_home": "الرئيسية",
        "nav_about": "من نحن",
        "nav_about_fablab": "عن فاب لاب",
        "nav_paths": "مساراتنا",
        "nav_sections": "أقسامنا",
        "nav_facilities": "مرافقنا",
        "nav_services": "الخدمات",
        "nav_workshops": "الدورات",
        "nav_our_services": "خدماتنا",
        "nav_media": "المركز الإعلامي",
        "nav_success": "قصص النجاح",
        "nav_join": "انضم إلينا",
        "nav_volunteer": "التطوع",
        "nav_internship": "التدريب التعاوني",
        "nav_contact": "تواصل معنا",
        "nav_register": "تسجيل",
        "nav_login": "دخول",
        "nav_logout": "تسجيل الخروج",
        "welcome": "مرحبًا",

        // Hero Section
        "hero_title": "عن فاب لاب الأحساء",
        "hero_description": "أول معمل تصنيع رقمي متكامل في الأحساء يتيح للمجتمع فرصة نمذجة مشاريعهم عبر أحدث آلات التصنيع الرقمي وبإشراف فريق تقني من الخبراء والمهندسين كما يقدم المعمل العديد من البرامج التدريبية التقنية",
        "feature_1": "الابتكار",
        "feature_2": "التصنيع",
        "feature_3": "المجتمع",
        "cta_button": "اكتشف رؤيتنا",

        // Values Section
        "values_title": "رسالتنا، رؤيتنا، وأهدافنا",
        "values_subtitle": "أساسيات نجاحنا ومسيرتنا نحو التميز",
        "mission_title": "الرسالة",
        "mission_text": "نشر ثقافة الإبداع والاختراع ومساعدة المجتمع في تحويل أفكارهم إلى منتجات عبر أحدث تقنيات التصنيع الرقمي المتواجدة في الفاب لاب",
        "vision_title": "الرؤية",
        "vision_text": "أن يكون فاب لاب الأحساء وجهة التمكين الأولى للمبدعين والمبتكرين",
        "goals_title": "الأهداف",
        "goal_1": "نشر ثقافة التصنيع الرقمي والإبداع والاختراع",
        "goal_2": "تنفيذ مشاريع تسهم في حل بعض مشاكل المجتمع عبر تقنيات التصنيع الرقمي الحديثة",
        "goal_3": "عقد شراكات مع الجهات المهتمة بمجال الإبداع والاختراع",
        "goal_4": "توفير بيئة عمل آمنة بالفاب لاب",
        "goal_5": "تقديم برامج تدريبية نوعية في مجال التصنيع الرقمي",

        // Team Section
        "team_quote": "\"نسعى في فاب لاب الأحساء لنشر ثقافة التصنيع الرقمي في المجتمع وذلك عبر تدريب المهتمين على أحدث المعدات والآلات من خلال البرامج والمشاريع وورش العمل والمعسكرات التدريبية النوعية التي نقدمها بالتعاون مع فريقنا التطوعي\"",
        "team_title": "كلمة فريق فاب لاب الأحساء",
        "team_role": "فريق العمل المتخصص",

        // Footer
        "programmers_title": "المبرمجون",
        "programmer_1": "باسم المشموم",
        "programmer_2": "علي العبودي",
        "map_title": "موقعنا على الخريطة",
        "contact_title": "معلومات الاتصال",
        "contact_email": "البريد الإلكتروني: info@fablabahsa.org",
        "contact_phone": "الهاتف: 40004-58-013",
        "contact_address": "العنوان: الأحساء - حي الحزام الذهبي - شارع عين نجم",
        "hours_title": "أوقات العمل",
        "hours_text": "الأحد - الخميس: 10:00 ص - 8:00 م",
        "contact_form_title": "أرسل لنا رسالة",
        "form_name": "اسمك الكامل",
        "form_email": "بريدك الإلكتروني",
        "form_message": "رسالتك هنا...",
        "form_submit": "إرسال الرسالة",
        "copyright": "© 2025 فاب لاب الأحساء - مبادرة مؤسسة عبد المنعم الراشد الإنسانية",

        // Chatbot
        "chatbot_title": "دردشة فاب لاب الأحساء - مدعومة بالذكاء الاصطناعي",
        "chatbot_welcome": "مرحبًا , أنا مساعد فاب لاب الأحساء . كيف يمكنني مساعدتك اليوم ؟",
        "chatbot_placeholder": "اكتب سؤالك هنا...",
        "chatbot_send": "إرسال",

        // Notifications
        "notifications_title": "الإشعارات",
        "notifications_done": "تم"
    },
    en: {
        // Navigation
        "nav_home": "Home",
        "nav_about": "About Us",
        "nav_about_fablab": "About Fab Lab",
        "nav_paths": "Our Paths",
        "nav_sections": "Our Sections",
        "nav_facilities": "Our Facilities",
        "nav_services": "Services",
        "nav_workshops": "Workshops",
        "nav_our_services": "Our Services",
        "nav_media": "Media Center",
        "nav_success": "Success Stories",
        "nav_join": "Join Us",
        "nav_volunteer": "Volunteer",
        "nav_internship": "Cooperative Training",
        "nav_contact": "Contact Us",
        "nav_register": "Register",
        "nav_login": "Login",
        "nav_logout": "Logout",
        "welcome": "Welcome",

        // Hero Section
        "hero_title": "About Fab Lab Al Ahsa",
        "hero_description": "The first integrated digital manufacturing lab in Al Ahsa that enables the community to model their projects using the latest digital manufacturing machines under the supervision of a technical team of experts and engineers. The lab also offers many technical training programs",
        "feature_1": "Innovation",
        "feature_2": "Manufacturing",
        "feature_3": "Community",
        "cta_button": "Discover Our Vision",

        // Values Section
        "values_title": "Our Mission, Vision, and Goals",
        "values_subtitle": "The foundations of our success and journey towards excellence",
        "mission_title": "Mission",
        "mission_text": "Spreading the culture of creativity and invention, helping the community transform their ideas into products through the latest digital manufacturing technologies available at Fab Lab",
        "vision_title": "Vision",
        "vision_text": "For Fab Lab Al Ahsa to be the premier empowerment destination for creators and innovators",
        "goals_title": "Goals",
        "goal_1": "Spread the culture of digital manufacturing, creativity, and invention",
        "goal_2": "Implement projects that contribute to solving some community problems through modern digital manufacturing technologies",
        "goal_3": "Establish partnerships with entities interested in creativity and invention",
        "goal_4": "Provide a safe working environment at Fab Lab",
        "goal_5": "Offer quality training programs in digital manufacturing",

        // Team Section
        "team_quote": "\"We at Fab Lab Al Ahsa strive to spread the culture of digital manufacturing in the community by training interested individuals on the latest equipment and machines through the programs, projects, workshops, and specialized training camps that we offer in cooperation with our volunteer team\"",
        "team_title": "Fab Lab Al Ahsa Team Message",
        "team_role": "Specialized Work Team",

        // Footer
        "programmers_title": "Programmers",
        "programmer_1": "Basem Al Mashmoum",
        "programmer_2": "Ali Al Aboudi",
        "map_title": "Our Location on Map",
        "contact_title": "Contact Information",
        "contact_email": "Email: info@fablabahsa.org",
        "contact_phone": "Phone: 013-58-40004",
        "contact_address": "Address: Al Ahsa - Al Hezam Al Thahabi District - Ain Najm Street",
        "hours_title": "Working Hours",
        "hours_text": "Sunday - Thursday: 10:00 AM - 8:00 PM",
        "contact_form_title": "Send us a message",
        "form_name": "Your full name",
        "form_email": "Your email",
        "form_message": "Your message here...",
        "form_submit": "Send Message",
        "copyright": "© 2025 Fab Lab Al Ahsa - An initiative of Abdulmunem Al Rashed Humanitarian Foundation",

        // Chatbot
        "chatbot_title": "Fab Lab Al Ahsa Chat - Powered by AI",
        "chatbot_welcome": "Hello, I'm Fab Lab Al Ahsa assistant. How can I help you today?",
        "chatbot_placeholder": "Type your question here...",
        "chatbot_send": "Send",

        // Notifications
        "notifications_title": "Notifications",
        "notifications_done": "Done"
    }
};

// Language Management Functions
let currentLanguage = 'ar';

function switchLanguage(lang) {
    currentLanguage = lang;
    
    // Update HTML direction and lang attribute
    const htmlElement = document.getElementById('htmlElement');
    htmlElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
    htmlElement.lang = lang;
    
    // Update all translatable elements
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[lang][key]) {
            element.textContent = translations[lang][key];
        }
    });
    
    // Update placeholder texts
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (translations[lang][key]) {
            element.placeholder = translations[lang][key];
        }
    });
    
    // Update language switch button text
    const languageSwitch = document.getElementById('languageSwitch');
    if (languageSwitch) {
        languageSwitch.textContent = lang === 'ar' ? 'EN' : 'AR';
    }
    
    // Save language preference
    localStorage.setItem('preferredLanguage', lang);
}

// Mobile Menu Functionality
document.addEventListener('DOMContentLoaded', function() {
    // Mobile menu elements
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const mobileMenuClose = document.getElementById('mobileMenuClose');
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    const mainNav = document.getElementById('mainNav');
    
    // Toggle mobile menu
    function toggleMobileMenu() {
        mainNav.classList.toggle('active');
        mobileMenuOverlay.classList.toggle('active');
        document.body.style.overflow = mainNav.classList.contains('active') ? 'hidden' : '';
    }
    
    // Event listeners for mobile menu
    if (mobileMenuToggle) {
        mobileMenuToggle.addEventListener('click', toggleMobileMenu);
    }
    
    if (mobileMenuClose) {
        mobileMenuClose.addEventListener('click', toggleMobileMenu);
    }
    
    if (mobileMenuOverlay) {
        mobileMenuOverlay.addEventListener('click', toggleMobileMenu);
    }
    
    // Close mobile menu when clicking on nav links
    const navLinks = document.querySelectorAll('.nav a');
    navLinks.forEach(link => {
        link.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                toggleMobileMenu();
            }
        });
    });
    
    // Handle dropdown menus on mobile
    const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
    dropdownToggles.forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            if (window.innerWidth <= 768) {
                e.preventDefault();
                const dropdown = this.parentElement;
                dropdown.classList.toggle('active');
                
                // Close other dropdowns
                dropdownToggles.forEach(otherToggle => {
                    if (otherToggle !== this) {
                        otherToggle.parentElement.classList.remove('active');
                    }
                });
            }
        });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (window.innerWidth <= 768) {
            if (!e.target.closest('.dropdown')) {
                dropdownToggles.forEach(toggle => {
                    toggle.parentElement.classList.remove('active');
                });
            }
        }
    });
    
    // Language Switch
    const languageSwitch = document.getElementById('languageSwitch');
    if (languageSwitch) {
        languageSwitch.addEventListener('click', function(e) {
            e.preventDefault();
            const newLang = currentLanguage === 'ar' ? 'en' : 'ar';
            switchLanguage(newLang);
        });
    }
    
    // Load saved language preference
    const savedLanguage = localStorage.getItem('preferredLanguage') || 'ar';
    switchLanguage(savedLanguage);
    
    // Star Background Animation
    function initStarBackground() {
        const canvas = document.getElementById('star-canvas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        let stars = [];
        let shootingStars = [];
        
        function initStars() {
            stars = [];
            const starCount = Math.min(200, Math.floor((canvas.width * canvas.height) / 2000));
            for (let i = 0; i < starCount; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 2 + 0.5,
                    speed: Math.random() * 0.5 + 0.1,
                    opacity: Math.random() * 0.8 + 0.2,
                    twinkleSpeed: Math.random() * 0.05 + 0.02,
                    twinkleOffset: Math.random() * Math.PI * 2
                });
            }
        }
        
        function createShootingStar() {
            if (Math.random() < 0.02 && shootingStars.length < 2) {
                shootingStars.push({
                    x: Math.random() * canvas.width,
                    y: 0,
                    speedX: (Math.random() * 3 + 2) * (Math.random() > 0.5 ? 1 : -1),
                    speedY: Math.random() * 2 + 2,
                    size: Math.random() * 2 + 1,
                    opacity: 1,
                    trail: []
                });
            }
        }
        
        function updateStars() {
            stars.forEach(star => {
                star.twinkleOffset += star.twinkleSpeed;
                star.opacity = 0.2 + Math.sin(star.twinkleOffset) * 0.3;
            });
        
            shootingStars.forEach((star, index) => {
                star.x += star.speedX;
                star.y += star.speedY;
                star.opacity -= 0.02;
                
                star.trail.push({ x: star.x, y: star.y });
                if (star.trail.length > 10) {
                    star.trail.shift();
                }
                
                if (star.opacity <= 0 || star.x < 0 || star.x > canvas.width || star.y > canvas.height) {
                    shootingStars.splice(index, 1);
                }
            });
        }
        
        function drawStars() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            stars.forEach(star => {
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                ctx.fill();
            });
            
            shootingStars.forEach(star => {
                ctx.strokeStyle = `rgba(255, 255, 255, ${star.opacity})`;
                ctx.lineWidth = star.size;
                ctx.beginPath();
                ctx.moveTo(star.trail[0].x, star.trail[0].y);
                for (let i = 1; i < star.trail.length; i++) {
                    ctx.lineTo(star.trail[i].x, star.trail[i].y);
                }
                ctx.stroke();
            });
        }
        
        function animateStars() {
            updateStars();
            drawStars();
            createShootingStar();
            requestAnimationFrame(animateStars);
        }
        
        initStars();
        animateStars();
    }
    
    // Sticky Header
    window.addEventListener('scroll', () => {
        const header = document.querySelector('.header');
        if (header) {
            if (window.scrollY > 50) {
                header.classList.add('sticky');
            } else {
                header.classList.remove('sticky');
            }
        }
    });
    
    // Chatbot Functionality
    let conversationHistory = [];
    
    const chatbotToggle = document.querySelector('.chatbot-toggle');
    const chatbotContainer = document.querySelector('.chatbot-container');
    const chatbotClose = document.querySelector('.chatbot-close');
    const chatbotInput = document.getElementById('chatbot-input');
    const chatbotSend = document.getElementById('chatbot-send');
    const chatbotMessages = document.getElementById('chatbot-messages');
    
    function addMessage(text, isUser = false) {
        if (chatbotMessages) {
            const message = document.createElement('div');
            message.className = `chatbot-message ${isUser ? 'user' : 'bot'}`;
            message.textContent = text;
            chatbotMessages.appendChild(message);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }
    }
    
    async function sendMessageToOpenRouter(message) {
        try {
            const context = currentLanguage === 'ar' 
                ? `أنت مساعد ذكي لفاب لاب الأحساء، أول معمل تصنيع رقمي في الأحساء. نساعد المجتمع في نمذجة المشاريع باستخدام أحدث آلات التصنيع الرقمي، بإشراف خبراء ومهندسين، ونقدم برامج تدريبية تقنية. الرسالة: نشر ثقافة الإبداع والاختراع. الرؤية: أن نكون الوجهة الأولى للمبدعين. رد بالعربية بأسلوب ودود ومختصر. السؤال: ${message}`
                : `You are a smart assistant for Fab Lab Al Ahsa, the first digital manufacturing lab in Al Ahsa. We help the community model projects using the latest digital manufacturing machines, supervised by experts and engineers, and we offer technical training programs. Mission: Spreading the culture of creativity and invention. Vision: To be the premier destination for creators. Respond in English in a friendly and concise manner. Question: ${message}`;
            
            conversationHistory.push({ role: 'user', content: message });
            if (conversationHistory.length > 2) conversationHistory.shift();
    
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer 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',
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.origin,
                    'X-Title': 'FabLab Chatbot'
                },
                body: JSON.stringify({
                    model: 'meta-llama/llama-3.2-3b-instruct',
                    messages: [{ role: 'user', content: context }],
                    max_tokens: 100,
                    temperature: 0.7
                })
            });
    
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
    
            const data = await response.json();
            let botResponse = data.choices[0].message.content || (currentLanguage === 'ar' ? 'عذرًا، لم أفهم السؤال. حاول صياغته بطريقة أخرى.' : 'Sorry, I did not understand the question. Try rephrasing it.');
            botResponse = botResponse.replace(/<[^>]+>/g, '').trim();
            if (botResponse.length > 200) {
                botResponse = botResponse.substring(0, 200) + '...';
            }
    
            conversationHistory.push({ role: 'assistant', content: botResponse });
            return botResponse;
        } catch (error) {
            console.error('Error communicating with OpenRouter:', error);
            return currentLanguage === 'ar' 
                ? 'عذرًا، حدث خطأ في التواصل. حاول مرة أخرى لاحقًا.'
                : 'Sorry, there was a communication error. Please try again later.';
        }
    }
    
    if (chatbotToggle && chatbotContainer && chatbotClose && chatbotInput && chatbotSend && chatbotMessages) {
        chatbotToggle.addEventListener('click', () => {
            chatbotContainer.classList.toggle('active');
        });
    
        chatbotClose.addEventListener('click', () => {
            chatbotContainer.classList.remove('active');
        });
    
        chatbotSend.addEventListener('click', async () => {
            const message = chatbotInput.value.trim();
            if (!message) return;
    
            addMessage(message, true);
            chatbotInput.value = '';
    
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'chatbot-message bot';
            loadingMessage.textContent = currentLanguage === 'ar' ? 'جارٍ المعالجة...' : 'Processing...';
            chatbotMessages.appendChild(loadingMessage);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    
            const botResponse = await sendMessageToOpenRouter(message);
            
            setTimeout(() => {
                loadingMessage.remove();
                addMessage(botResponse);
            }, 500);
        });
    
        chatbotInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                chatbotSend.click();
            }
        });
    }
    
    // Form submission handling
    const footerContactForm = document.getElementById('footerContactForm');
    if (footerContactForm) {
        footerContactForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const name = formData.get('name');
            const email = formData.get('email');
            const message = formData.get('message');
            
            console.log('Form submitted:', { name, email, message });
            
            const successMessage = currentLanguage === 'ar' 
                ? 'شكرًا لك! تم استلام رسالتك وسنقوم بالرد عليك قريبًا.'
                : 'Thank you! Your message has been received and we will respond to you soon.';
            alert(successMessage);
            this.reset();
        });
    }
    
    // Smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            
            const targetId = this.getAttribute('href');
            if (targetId === '#') return;
            
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                const headerHeight = document.querySelector('.header').offsetHeight;
                window.scrollTo({
                    top: targetElement.offsetTop - headerHeight,
                    behavior: 'smooth'
                });
            }
        });
    });
    
    // Image hover effects
    const images = document.querySelectorAll('.image-container img, .image-frame img');
    images.forEach(img => {
        img.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05)';
        });
        
        img.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });
    
    // Animation for value cards
    const valueCards = document.querySelectorAll('.value-card-new');
    function checkScroll() {
        valueCards.forEach(card => {
            const cardTop = card.getBoundingClientRect().top;
            const windowHeight = window.innerHeight;
            
            if (cardTop < windowHeight * 0.85) {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }
        });
    }
    
    valueCards.forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
    });
    
    window.addEventListener('scroll', checkScroll);
    checkScroll();
    
    // Floating elements animation
    const floatingElements = document.querySelectorAll('.floating-element');
    floatingElements.forEach((element, index) => {
        element.style.animationDelay = `${index * 2}s`;
    });
    
    // Initialize star background
    initStarBackground();
});

// Handle page load
window.addEventListener('load', function() {
    document.body.classList.add('loaded');
    
    // Remove loading animation if any
    const loading = document.querySelector('.loading');
    if (loading) {
        setTimeout(() => {
            loading.style.display = 'none';
        }, 500);
    }
});

// Handle window resize for responsive adjustments
window.addEventListener('resize', function() {
    // Reinitialize any responsive elements if needed
    const canvas = document.getElementById('star-canvas');
    if (canvas) {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
});
